/*
* jQuery spiral image gallery plugin
*
* url		http://www.amdonnelly.co.uk/experiments/spiral-gallery-plugin
* author	Alan Donnelly 2012
* version	0.5
* license	MIT and GPL licenses
*/
(function(b){b.fn.SpiralImages=function(p){var f={options:{rotateImages:!1,useModal:!1},images:{list:{},count:0,current:0,openCurrent:!1},animation:{animate:!1,fps:30,speed:0,target:0},imageMod:{space:8,opacity:.005,scale:.005,position:0,move:.9},spiral:{centerX:0,centerY:0,radius:0,sides:225,coils:3,rotation:0,shrinkRadius:60},borders:{normal:{color:"#596269",width:5},hover:{color:"#006699",width:10},selected:{color:"#000000",width:10}}};return this.each(function(){function A(a){N();B=a.find("img").length; 0==_spiral.radius&&(m.width()<m.height()?_spiral.radius=m.width()/2:_spiral.radius=m.height()/2);_spiral.shrinkRadius&&(_spiral.radius-=_spiral.shrinkRadius);0==_spiral.centerX&&(_spiral.centerX=m.width()/2);0==_spiral.centerY&&(_spiral.centerY=m.height()/2);C=_spiral.radius/_spiral.sides;D=_spiral.coils/_spiral.sides;v=2*D*Math.PI;_spiral.rotation=2*_spiral.rotation*Math.PI;_animation.speed=1E3/_animation.fps;b(window).mousemove(function(a){_mouse.x=a.pageX;_mouse.y=a.pageY});r=new Kinetic.Stage({container:m.attr("id"), width:m.width(),height:m.height()});w=new Kinetic.Layer;a.find("img").each(function(){_images.list[_images.count]=new O({parent:m,layer:w,image:b(this),index:_images.count,containerChildren:B});_images.count++});r.add(w)}function N(){jQuery.parseJSON(p);for(var a in p)for(var g in p[a])if(null!=f[a][g])switch(b.type(f[a][g])){case "string":f[a][g]=p[a][g];break;case "boolean":f[a][g]="true"==String(p[a][g]).toLowerCase()?!0:!1;break;case "number":f[a][g]=parseFloat(p[a][g])}}function O(a){this._height= this._width=this._z=this._y=this._x=0;this._scale=1;this._position=0;this._index;this._rotation=this._opacity=0;this._image;this._element;this._top=!1;this.spiral_content;this.spiral_media;this.media;this.start={width:0,height:0,z:0};this.SetImagePosition=function(){this._position=this._index*_imageMod.space-_imageMod.position;this._top=0==this._position?!0:!1;return!1};this.SetImageCoords=function(){var a=_spiral.radius-this._position*C,b=this._position*v+_spiral.rotation;this._x=_spiral.centerX+ Math.cos(b)*a;this._y=_spiral.centerY+Math.sin(b)*a;this._element.setX(this._x);this._element.setY(this._y);return!1};this.SetImageScale=function(){this._scale=0<this._position?1-E(_imageMod.scale,this._position):1;0>this._scale&&(this._scale=0);this._element.setScale(this._scale);return!1};this.SetImageOpacity=function(){var a=E(_imageMod.opacity,this._position);0>a&&(a=0);1<a&&(a=1);this._opacity=0<this._position?1-a:1;0>this._opacity&&(this._opacity=0);0>this._position&&(this._opacity=1- -1*this._position/ 10,1<this._opacity?this._opacity=1:0>this._opacity&&(this._opacity=0));this._element.setOpacity(this._opacity);0>=this._opacity?this._element.hide():this._element.show();return!1};this.SetImageRotation=function(){_options.rotateImages&&(this._rotation=this._position*v+_spiral.rotation,this._element.setRotation(this._rotation))};this.ResetImageOpacity=function(){this._opacity=1;return!1};this.SetStroke=function(a){a||(a="normal");if("hover"==a&&0==this._position)return!1;"normal"==a&&0==this._position&& (a="selected");_borders[a]&&(this._element.setStroke(_borders[a].color),this._element.setStrokeWidth(_borders[a].width))};this.SetZIndex=function(){0==this._position?this._element.moveToTop():this._element.setZIndex(this._z)};this.RefreshImage=function(){this.SetImagePosition();this.SetImageCoords();this.SetImageScale();this.SetImageOpacity();this.SetImageRotation();this.SetStroke();this.SetZIndex();return!1};this.MouseOverDo=function(){this._element.setScale(1);this._element.setOpacity(1);this._element.moveToTop(); this._element.setRotation(0);this.SetStroke("hover");document.body.style.cursor="pointer";r.draw()};this.MouseOutDo=function(){this._element.setScale(this._scale);this._element.setOpacity(this._opacity);this.SetZIndex();this.SetImageRotation();this.SetStroke();document.body.style.cursor="default";r.draw()};this.MouseClickDo=function(){};this.Init=function(){this._width=this._image.width;this._height=this._image.height;this._position=0;this._index=a.index;this._z=-this._index-2;this.SetImagePosition(); this._element=new Kinetic.Image({id:this._index,image:this._image,x:this._x,y:this._y,width:this._width,height:this._height});this._element.setOffset(this._image.width/2,this._image.height/2);this.SetImageCoords();this.SetImageScale();this.SetImageOpacity();this.SetStroke();this._element.on("mouseover",function(){_images.list[this.attrs.id].MouseOverDo()});this._element.on("mouseout",function(){_images.list[this.attrs.id].MouseOutDo()});this._element.on("click",function(){var a=this.attrs.id;F(a); _images.list[a].MouseClickDo()});a.layer.add(this._element);this.SetZIndex();this.SetImageRotation()};this.spiral_content=a.image.attr("spiral-content");this.spiral_media=a.image.attr("data-spiral-media");this._image=new Image;this._image.src=a.image.attr("src");this._image.onload=this.Init();return this}function x(a){_images.current=a;q()}function F(a){_images.openCurrent=!0;_images.current=a;q()}function q(){_animation.target=_images.current*_imageMod.space;_imageMod.step=_imageMod.move;_animation.animate|| G()}function G(){_animation.animate=!1;_animation.target!=_imageMod.position?(_animation.animate=!0,Q(),_animation.target>_imageMod.position?(_imageMod.position+=_imageMod.step,_imageMod.position>_animation.target&&(_imageMod.position=_animation.target)):(_imageMod.position-=_imageMod.step,_imageMod.position<_animation.target&&(_imageMod.position=_animation.target)),H(),_animation.animate&&setTimeout(function(){G()},_animation.speed)):(_images.openCurrent&&(_images.openCurrent=!1,y()),_animation.animate= !1)}function Q(){var a=0;_animation.target>_imageMod.position?a=_animation.target-_imageMod.position:_imageMod.position>_animation.target&&(a=_imageMod.position-_animation.target);a<=3*_imageMod.move&&(_imageMod.step*=.75);.2>_imageMod.step&&(_imageMod.step=.2);return!1}function H(){for(var a=0;a<_images.count;a++)_images.list[a].RefreshImage();r.draw()}function y(){var a=_images.list[_images.current],g=a.spiral_content,P=a.spiral_media;if(null==e||a.media!=e)null!=g||null!=P?(c?h.html(""):(h=b(document.createElement("div")).addClass("inner"), c=b(document.createElement("div")).addClass("spiral-pop-up").append(h),b("body").prepend(c),_options.useModal&&!0==_options.useModal&&(n=b(document.createElement("div")).addClass("spiral-modal"),b("body").prepend(n),n.hide())),_options.useModal&&!0==_options.useModal&&(z(),I("on")),k&&k.stop(!0,!1).hide(),l&&s("off"),e&&e.stop(!0,!1).hide(),c.is(":visible")||(h.remove(),h=b(document.createElement("div")).addClass("inner"),c.prepend(h)),b(window).unbind("resize",t).resize(t),c.stop(!0,!1),t(),c.fadeIn("fast", R(a))):J()}function t(){c&&c.css({left:b("html").outerWidth()/2-c.outerWidth()/2,top:b("html").outerHeight()/2-c.outerHeight()/2});return!1}function R(a){var g=a.spiral_media;e&&e.hide();null!=g&&0<g.length&&(h.addClass("loading"),null==a.media?(a.media=b("<img class='media'/>").attr("src",g).load({image:a},K),e=a.media):(e=a.media,K()));return!1}function K(){h.removeClass("loading");var a=parseInt(h.css("max-width")),b=parseInt(h.css("max-height"));e.hide();h.append(e);var c=e.width(),d=e.height(), f=c/d;c>a&&(c=a,d=c/f);d>b&&(d=b,c=d*f);e.attr("width",c+"px");e.attr("height",d+"px");h.animate({width:c,height:d},{step:t,complete:S});return!1}function S(){e.stop().hide().fadeIn("fast");l||(l=b(document.createElement("div")).addClass("control").addClass("nav").hide(),c.append(l),L=b(document.createElement("div")).addClass("btn").addClass("prev").click(T),M=b(document.createElement("div")).addClass("btn").addClass("next").click(U),l.append(L).append(M));l&&l.css({top:c.height()/2});s("on");k|| (k=b(document.createElement("div")).addClass("control").addClass("close").click(J),c.append(k));k&&k.css({top:-k.height()/2,left:c.outerWidth()-k.width()/2});k.stop().fadeIn("fast")}function T(){var a=_images.current-1,b=_images.count;for(s("off");-1<b;){0>a&&(a=_images.count-1);if(null!=_images.list[a].spiral_media){_images.current=a;break}a--;b--}y();x(_images.current)}function U(){var a=_images.current+1,b=_images.count;for(s("off");-1<b;){a>=_images.count&&(a=0);if(null!=_images.list[a].spiral_media){_images.current= a;break}a++;b--}y();x(_images.current)}function s(a){"on"==a?(V()&&l.fadeIn("fast"),c.hover(function(){l.fadeIn("fast")},function(){l.hide()})):"off"==a&&(c.unbind(),l.hide());return!1}function V(){var a=!1;_mouse.x>c.offset().left&&_mouse.x<c.offset().left+c.outerWidth()&&_mouse.y>c.offset().top&&_mouse.y<c.offset().top+c.outerHeight()&&(a=!0);return a}function J(){c.fadeOut(W);I("off");e=null;return!1}function W(){k.hide();b(window).unbind("resize",t);s("off");return!1}function z(){n&&(n.width(b(window).outerWidth()), n.height(b(window).outerHeight()));return!1}function I(a){n&&("on"==a?(n.stop().fadeIn("fast"),b(window).resize(z)):"off"==a&&(n.stop().fadeOut("fast"),b(window).unbind("resize",z)));return!1}function E(a,b){for(var c=0,d=0;d<=b;d++)c+=a;return c}var u=b(this);u.html();var m=u.parent(),B=0,r,w;_options=f.options;_images=f.images;_animation=f.animation;_imageMod=f.imageMod;_spiral=f.spiral;_borders=f.borders;_mouse={x:0,y:0};var C,D,v;u.hide();b.browser.msie?b(window).load(A(u)):b(window).load(function(){A(u)}); b.fn.SpiralImages.MoveBy=function(a){_imageMod.position+=a;H()};b.fn.SpiralImages.MoveNext=function(){_images.current=_images.current<_images.count-1?_images.current+1:_images.count-1;q()};b.fn.SpiralImages.MovePrev=function(){_images.current=1<=_images.current?_images.current-1:0;q()};b.fn.SpiralImages.StopAnim=function(){if(_animation.animate){var a=1E4,b;if(_animation.target>_imageMod.position)for(var c=0;c<_images.count;c++){var d=_images.list[c];0<d._position&&d._position<a&&(a=d._position,b= d)}else for(a*=-1,c=0;c<_images.count;c++)d=_images.list[c],0>d._position&&d._position>a&&(a=d._position,b=d);b&&(_animation.target=b._index*_imageMod.space,_images.current=b._index)}};b.fn.SpiralImages.MoveFirst=function(){_images.current=0;q()};b.fn.SpiralImages.MoveLast=function(){_images.current=_images.count-1;q()};b.fn.SpiralImages.MoveTo=function(a){x(a)};b.fn.SpiralImages.MoveToAndOpen=function(a){F(a)};var c,h,e,k,l,L,M,n})}})(jQuery);